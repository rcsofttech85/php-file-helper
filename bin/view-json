#!/usr/bin/env php
<?php

use rcsofttech85\FileHandler\DI\ServiceContainer;
use rcsofttech85\FileHandler\Exception\FileHandlerException;
use rcsofttech85\FileHandler\JsonFileHandler;
use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\SingleCommandApplication;
use Symfony\Component\Console\Style\SymfonyStyle;

require 'vendor/autoload.php';

$command = (new SingleCommandApplication())
    ->addArgument('jsonFile', InputArgument::REQUIRED, 'json file name')
    ->addOption('hide-column', null, InputOption::VALUE_REQUIRED, 'Columns to hide (comma-separated)')
    ->addOption('limit', null, InputOption::VALUE_REQUIRED, 'limit number of records')
    ->setCode(function (InputInterface $input, OutputInterface $output): int {
        $io = new SymfonyStyle($input, $output);
        $jsonFile = $input->getArgument('jsonFile');

        if (!file_exists($jsonFile)) {
            $io->error("{$jsonFile} does not exists");
            return Command::FAILURE;
        }

        $serviceContainer = new ServiceContainer();
        /** @var JsonFileHandler $jsonFileHandler */
        $jsonFileHandler = $serviceContainer->getContainerBuilder()->get('json_file_handler');

        try {
            $data = $jsonFileHandler->toArray($jsonFile);
        } catch (FileHandlerException) {
            $io->error('invalid json file');
            return Command::FAILURE;
        }

        $headers = array_keys(reset($data));
        $io->title($jsonFile);
        $table = $io->createTable();
        $table->setHeaders($headers);
        $table->setRows($data);
        $table->render();
        $io->newLine();

        return Command::SUCCESS;
    })->run();
